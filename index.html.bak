<!doctype html>



  


<html class="theme-next muse use-motion">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="fonts.gmirror.org/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta property="og:type" content="website">
<meta property="og:title" content="CuberL">
<meta property="og:url" content="http://cuberl.com/index.html">
<meta property="og:site_name" content="CuberL">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="CuberL">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>




  <link rel="canonical" href="http://cuberl.com/"/>

  <title> CuberL </title><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">CuberL</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/09/17/make-a-drcom-client-by-yourself/" itemprop="url">
                  一个Drcom客户端的实现
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-09-17T20:39:45+08:00" content="2016-09-17">
              2016-09-17
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>本文仅适用韶关学院Drcom客户端。</p>
<p>因为自己需要经常用到Linux的缘故，所以打算把Linux上的网络问题搞定。学校使用的是Drcom认证客户端，在学校MIS系统上也提供了对应的Linux版本。可惜的是把一切依赖都弄好终于能运行后却总是秒断。这个程序并没有提供源码，我也无法获知是什么问题，所以打算干脆自己写一个，也就刚好分析一下Drcom的协议。</p>
<h2 id="0x00-工作准备"><a href="#0x00-工作准备" class="headerlink" title="0x00 工作准备"></a>0x00 工作准备</h2><ul>
<li>抓包软件Wireshark</li>
<li>反汇编器IDA Pro</li>
<li>能正常使用的Windows版Drcom客户端</li>
</ul>
<h2 id="0x01-EAP协议"><a href="#0x01-EAP协议" class="headerlink" title="0x01 EAP协议"></a>0x01 EAP协议</h2><p>简单的实验可以发现，在没有登陆内网前，机器并不能Ping通网关，也就是说认证的方式应该是通过广播的方式来进行的。通过Wireshark抓包可以得到几个重要的包：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">EAPOL	96	Start   04:44:23.334841000</div><div class="line"></div><div class="line">0000   ff ff ff ff ff ff 28 d2 44 2d 90 69 88 8e 01 01  ......(.D-.i....</div><div class="line">0010   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................</div><div class="line">0020   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................</div><div class="line">0030   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................</div><div class="line">0040   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................</div><div class="line">0050   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................</div></pre></td></tr></table></figure>
<p>协议的类型为0x888e，也即<a href="http://www.ietf.org/rfc/rfc3748.txt" target="_blank" rel="external">EAP</a>，可扩展身份验证协议，是802.1x认证机制的核心。而EAPOL则是基于局域网的EAP。当我们的机器开始登录时，首先会向广播地址发出一个Start包，同在一个局域网的网关便会收到这个Start包并回复：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">EAP	60	Request, Identity	04:44:23.335480000</div><div class="line"></div><div class="line">0000   28 d2 44 2d 90 69 58 6a b1 56 78 00 88 8e 01 00  (.D-.iXj.Vx.....</div><div class="line">0010   00 05 01 01 00 05 01 00 00 00 00 00 00 00 00 00  ................</div><div class="line">0020   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................</div><div class="line">0030   00 00 00 00 00 00 00 00 98 a7 44 0c              ..........D.</div></pre></td></tr></table></figure>
<p>这个包即是向客户端请求一个Identity，也即身份信息。客户端收到这个request后，就应该向网关回应一个Identity：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">EAP	96	Response, Identity	04:44:23.459779000</div><div class="line"></div><div class="line">0000   ff ff ff ff ff ff 28 d2 44 2d 90 69 88 8e 01 00  ......(.D-.i....</div><div class="line">0010   00 19 02 01 00 19 01 31 34 31 31 35 30 36 31 30  .......141150610</div><div class="line">0020   32 34 00 44 61 00 00 c0 a8 c3 5f 00 00 00 00 00  24.Da....._.....</div><div class="line">0030   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................</div><div class="line">0040   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................</div><div class="line">0050   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................</div></pre></td></tr></table></figure>
<p>这个包已经开始包含学号和IP地址，当网关收到这个Identity后，网关开始请求一个MD5-Challenge：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">EAP	60	Request, MD5-Challenge EAP (EAP-MD5-CHALLENGE)	04:44:23.462349000</div><div class="line"></div><div class="line">0000   28 d2 44 2d 90 69 58 6a b1 56 78 00 88 8e 01 00  (.D-.iXj.Vx.....</div><div class="line">0010   00 1a 01 00 00 1a 04 10 19 54 6c 79 c0 a8 7f 81  .........Tly....</div><div class="line">0020   c0 a8 7f 81 00 00 00 00 10 82 00 00 00 00 00 00  ................</div><div class="line">0030   00 00 00 00 00 00 00 00 94 96 f5 b8              ............</div></pre></td></tr></table></figure>
<p>这个包中包含了一串Challenge值(<code>19 54 6c 79 c0 a8 7f 81 c0 a8 7f 81 00 00 00 00</code>)。客户端收到这个值后，将其与密码做MD5运算，则可得到Challenged-Password。$$<br>C = md5(Id+Challenge+Password)<br>$$在Drcom中Id固定为0。<br>得到这串Challenged-Password后，客户端将其与学号一同发给网关</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">EAP	96	Response, MD5-Challenge EAP (EAP-MD5-CHALLENGE) 04:44:23.991527000</div><div class="line"></div><div class="line">0000   ff ff ff ff ff ff 28 d2 44 2d 90 69 88 8e 01 00  ......(.D-.i....</div><div class="line">0010   00 2a 02 00 00 2a 04 10 9e 47 e9 3a 45 c7 d8 6d  .*...*...G.:E..m</div><div class="line">0020   18 38 24 c0 20 91 2b 6c 31 34 31 31 35 30 36 31  .8$. .+l14115061</div><div class="line">0030   30 32 34 00 44 61 24 00 c0 a8 c3 5f 00 00 00 00  024.Da$...._....</div><div class="line">0040   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................</div><div class="line">0050   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................</div></pre></td></tr></table></figure>
<p>网关收到这串Challenged-Password后进行验证，如果加密后的密码无误，则原密码也无误，就会发出一个Success包：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">EAP	60	Success	04:44:24.010811000</div><div class="line"></div><div class="line">0000   28 d2 44 2d 90 69 58 6a b1 56 78 00 88 8e 01 00  (.D-.iXj.Vx.....</div><div class="line">0010   00 04 03 00 00 04 00 00 00 00 00 00 00 00 00 00  ................</div><div class="line">0020   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................</div><div class="line">0030   00 00 00 00 00 00 00 00 55 00 41 e9              ........U.A.</div></pre></td></tr></table></figure>
<p>整个认证握手过程到这里就结束了。此时使用PPPoE进行连接，发现已经可以连接到外网，也就表示认证已经成功。</p>
<h2 id="0x02-认证过程的Go语言实现"><a href="#0x02-认证过程的Go语言实现" class="headerlink" title="0x02 认证过程的Go语言实现"></a>0x02 认证过程的Go语言实现</h2><p>Go语言中可以使用第三方包gopacket对数据包进行捕获和发送。但原版的gopacket在这个情景下使用会有些许问题，所以做了少许修改，并在文末附件给出。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* 发送EAPOL包 */</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">sendEAPOL</span><span class="params">(Version <span class="keyword">byte</span>, Type layers.EAPOLType, SrcMAC net.HardwareAddr, DstMAC net.HardwareAddr)</span></span> &#123;</div><div class="line">	buffer := gopacket.NewSerializeBuffer()</div><div class="line">	options := gopacket.SerializeOptions&#123;&#125;</div><div class="line">	gopacket.SerializeLayers(buffer, options,</div><div class="line">		&amp;layers.Ethernet&#123;EthernetType: layers.EthernetTypeEAPOL, SrcMAC: SrcMAC, DstMAC: DstMAC&#125;,</div><div class="line">		&amp;layers.EAPOL&#123;Version: <span class="number">0x01</span>, Type: layers.EAPOLTypeStart&#125;,</div><div class="line">	)</div><div class="line">	<span class="comment">//var err error</span></div><div class="line">	err := handle.WritePacketData(buffer.Bytes())</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		fmt.Print(err)</div><div class="line">		os.Exit(<span class="number">0</span>)</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/* 发送EAP包 */</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">sendEAP</span><span class="params">(Id <span class="keyword">uint8</span>, Type layers.EAPType, TypeData []<span class="keyword">byte</span>, Code layers.EAPCode, SrcMAC net.HardwareAddr, DstMAC net.HardwareAddr)</span></span> &#123;</div><div class="line">	buffer := gopacket.NewSerializeBuffer()</div><div class="line">	options := gopacket.SerializeOptions&#123;&#125;</div><div class="line">	gopacket.SerializeLayers(buffer, options,</div><div class="line">		&amp;layers.Ethernet&#123;EthernetType: layers.EthernetTypeEAPOL, SrcMAC: SrcMAC, DstMAC: DstMAC&#125;,</div><div class="line">		&amp;layers.EAPOL&#123;Version: <span class="number">0x01</span>, Type: layers.EAPOLTypeEAP, Length: <span class="keyword">uint16</span>(<span class="built_in">len</span>(TypeData) + <span class="number">5</span>)&#125;,</div><div class="line">		&amp;layers.EAP&#123;Id: Id, Type: Type, TypeData: TypeData, Code: Code, Length: <span class="keyword">uint16</span>(<span class="built_in">len</span>(TypeData) + <span class="number">5</span>)&#125;,</div><div class="line">	)</div><div class="line">	<span class="comment">// err error</span></div><div class="line">	err := handle.WritePacketData(buffer.Bytes())</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		fmt.Print(err)</div><div class="line">		os.Exit(<span class="number">0</span>)</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>首选封装两个函数分别用来发送EAPOL包和EAP包，gopacket的用法请参考<a href="https://godoc.org/github.com/google/gopacket" target="_blank" rel="external">GoDoc</a>。</p>
<p>readNewPacket将从认证一开始就以一个协程运行，直至程序终止。在程序main函数中，有如下语句：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">handle, err = pcap.OpenLive(devName, <span class="number">1024</span>, <span class="literal">false</span>, <span class="number">5</span>*time.Second)</div><div class="line"><span class="keyword">defer</span> handle.Close()</div><div class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">	fmt.Print(err)</div><div class="line">	os.Exit(<span class="number">0</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line">packetSrc := gopacket.NewPacketSource(handle, handle.LinkType())</div><div class="line"><span class="keyword">go</span> readNewPacket(packetSrc)</div></pre></td></tr></table></figure></p>
<p>readNewPacket()会根据Code和Type分别进行处理。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* 读取新数据包 */</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">readNewPacket</span><span class="params">(packetSrc *gopacket.PacketSource)</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> packet := <span class="keyword">range</span> packetSrc.Packets() &#123;</div><div class="line">		eapl := packet.Layer(layers.LayerTypeEAP)</div><div class="line">		<span class="keyword">if</span> eapl != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">switch</span> eapl.(*layers.EAP).Code &#123;</div><div class="line">			<span class="keyword">case</span> <span class="number">0x03</span>: <span class="comment">//Success</span></div><div class="line">				fmt.Println(<span class="string">"Success"</span>)</div><div class="line">				sendPingStart()</div><div class="line">			<span class="keyword">case</span> <span class="number">0x01</span>: <span class="comment">//Request</span></div><div class="line">				<span class="keyword">switch</span> <span class="keyword">int8</span>(eapl.(*layers.EAP).Type) &#123;</div><div class="line">				<span class="keyword">case</span> <span class="number">0x04</span>: <span class="comment">//EAP-MD5-CHALLENGE</span></div><div class="line">					<span class="comment">//fmt.Println(eapl.(*layers.EAP).TypeData)</span></div><div class="line">					<span class="keyword">go</span> responseMd5Challenge(eapl.(*layers.EAP).TypeData[<span class="number">1</span>:<span class="number">17</span>])</div><div class="line">				<span class="keyword">case</span> <span class="number">0x02</span>: <span class="comment">//Notification</span></div><div class="line">					fmt.Println(<span class="string">"Failed"</span>)</div><div class="line">					os.Exit(<span class="number">0</span>)</div><div class="line">				<span class="keyword">case</span> <span class="number">0x01</span>: <span class="comment">//Identity</span></div><div class="line">					<span class="comment">//fmt.Print("TRUE")</span></div><div class="line">					<span class="keyword">go</span> responseIndentity(eapl.(*layers.EAP).Id)</div><div class="line">				&#125;</div><div class="line">			<span class="keyword">case</span> <span class="number">0x04</span>: <span class="comment">//Failure</span></div><div class="line">				fmt.Println(<span class="string">"Failed"</span>)</div><div class="line">				fmt.Println(<span class="string">"Retry..."</span>)</div><div class="line">				EAPAuth()</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	end &lt;- <span class="literal">true</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* EAP认证开始 */</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">EAPAuth</span><span class="params">()</span></span> &#123;</div><div class="line">	fmt.Println(mac)</div><div class="line">	fmt.Println(<span class="string">"EAP Start..."</span>)</div><div class="line">	sendEAPOL(<span class="number">0x01</span>, layers.EAPOLTypeStart, mac, boardCastAddr)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/* EAP注销 */</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">EAPLogoff</span><span class="params">()</span></span> &#123;</div><div class="line">	sendEAPOL(<span class="number">0x01</span>, layers.EAPOLTypeLogOff, mac, boardCastAddr)</div><div class="line">	fmt.Println(<span class="string">"Logoff..."</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/* 回应身份(Indentity) */</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">responseIndentity</span><span class="params">(id <span class="keyword">byte</span>)</span></span> &#123;</div><div class="line">	dataPack := []<span class="keyword">byte</span>&#123;&#125;</div><div class="line">	dataPack = <span class="built_in">append</span>(dataPack, []<span class="keyword">byte</span>(username)...)                     <span class="comment">//用户名</span></div><div class="line">	dataPack = <span class="built_in">append</span>(dataPack, []<span class="keyword">byte</span>&#123;<span class="number">0x00</span>, <span class="number">0x44</span>, <span class="number">0x61</span>, <span class="number">0x00</span>, <span class="number">0x00</span>&#125;...) <span class="comment">//未知</span></div><div class="line">	dataPack = <span class="built_in">append</span>(dataPack, ip[:]...)                                <span class="comment">//客户端IP</span></div><div class="line">	fmt.Println(<span class="string">"Response Identity..."</span>)</div><div class="line">	sendEAP(id, <span class="number">0x01</span>, dataPack, <span class="number">2</span>, mac, boardCastAddr)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/* 回应MD5-Challenge */</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">responseMd5Challenge</span><span class="params">(m []<span class="keyword">byte</span>)</span></span> &#123;</div><div class="line">	mPack := []<span class="keyword">byte</span>&#123;&#125;</div><div class="line">	mPack = <span class="built_in">append</span>(mPack, <span class="number">0</span>)</div><div class="line">	mPack = <span class="built_in">append</span>(mPack, []<span class="keyword">byte</span>(password)...)</div><div class="line">	mPack = <span class="built_in">append</span>(mPack, m...)</div><div class="line">	mCal := md5.New()</div><div class="line">	mCal.Write(mPack)</div><div class="line">	dataPack := []<span class="keyword">byte</span>&#123;&#125;</div><div class="line">	dataPack = <span class="built_in">append</span>(dataPack, <span class="number">16</span>)</div><div class="line">	dataPack = <span class="built_in">append</span>(dataPack, mCal.Sum(<span class="literal">nil</span>)...)</div><div class="line">	dataPack = <span class="built_in">append</span>(dataPack, []<span class="keyword">byte</span>(username)...)</div><div class="line">	dataPack = <span class="built_in">append</span>(dataPack, []<span class="keyword">byte</span>&#123;<span class="number">0x00</span>, <span class="number">0x44</span>, <span class="number">0x61</span>, <span class="number">0x26</span>, <span class="number">0x00</span>&#125;...)</div><div class="line">	dataPack = <span class="built_in">append</span>(dataPack, []<span class="keyword">byte</span>(ip[:])...)</div><div class="line">	challenge = mCal.Sum(<span class="literal">nil</span>) <span class="comment">//用于后面心跳包</span></div><div class="line">	fmt.Println(<span class="string">"Response EAP-MD5-Challenge..."</span>)</div><div class="line">	sendEAP(<span class="number">0</span>, <span class="number">0x04</span>, dataPack, <span class="number">2</span>, mac, boardCastAddr)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>按照前文所说的认证方法分别对各种回应包进行构造，然后调用<code>EAPAuth()</code>函数即可。<code>readNewPacket()</code>函数将收到来自网关的request，并交由不同的response函数处理。</p>
<p>至此，可以构造出一个可用的认证程序，使用系统自带的PPPoE拨号程序即可。</p>
<h2 id="0x03-问题的发现"><a href="#0x03-问题的发现" class="headerlink" title="0x03 问题的发现"></a>0x03 问题的发现</h2><p>使用这种认证方式虽然可以成功拨上号，但会发现隔一段时间就会自己掉线。通过Wireshark查看，发现网关主动发送了Failure包，也就是说网关注销了我们的账户。这种情况可以联想到使用官方客户端经常碰到的一个错误：</p>
<blockquote>
<p>获取用户属性超时！请检查防火墙配置允许 UDP 61440 端口。</p>
</blockquote>
<p>当客户端出现这个错误时，一般也可以上网，但一段时间后就会发现已经断开。所以我们重新打开校方提供的客户端，通过内网认证，并用wireshark筛选出UDP协议，端口为61440的所有数据包。</p>
<p>通过仔细查看会发现，客户端每隔一段时间会向一个服务器192.168.127.129:61440发送UDP报文，而服务器也会做出响应。也就是说，客户端应该是通过定时发送数据包来保持自己的在线状态，也就是所谓的心跳包。</p>
<h2 id="0x04-心跳包的分析"><a href="#0x04-心跳包的分析" class="headerlink" title="0x04 心跳包的分析"></a>0x04 心跳包的分析</h2><p>（以下出现的数据仅为UDP数据部分，而非完整的数据包）</p>
<p>当客户端与网关完成认证流程后，客户端便开始向服务器192.168.127.129:61440发送报文：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">0000   07 00 08 00 01 00 00 00                          ........</div></pre></td></tr></table></figure></p>
<p>一共只有八个字节，这部分是固定的，大部分Drcom心跳包都以07开头，其他部分含义未知。</p>
<p>然后服务器方面会回应一个报文：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">0000   07 00 10 00 02 00 00 00 01 72 96 00 c0 a8 c3 5f  .........r....._</div><div class="line">0010   a8 ac 00 00 4f e4 16 c1 00 00 00 00 dc 02 00 00  ....O...........</div></pre></td></tr></table></figure></p>
<p>具体含义我们暂且不管。收到这样的数据包后，客户端即发送一个数据包，包含用户的若干信息：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">0000   07 01 f4 00 03 0b 28 d2 44 2d 90 69 c0 a8 c3 5f  ......(.D-.i..._</div><div class="line">0010   02 22 00 24 01 72 96 00 4a 6a 72 32 00 00 00 00  .&quot;.$.r..Jjr2....</div><div class="line">0020   31 34 31 31 35 30 36 31 30 32 34 6c 7a 79 2d 70  14115061024lzy-p</div><div class="line">0030   63 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  c...............</div><div class="line">0040   00 00 00 00 00 00 00 00 00 00 00 df 05 05 05 00  ................</div><div class="line">0050   00 00 00 df 06 06 06 00 00 00 00 00 00 00 00 94  ................</div><div class="line">0060   00 00 00 06 00 00 00 02 00 00 00 f0 23 00 00 02  ............#...</div><div class="line">0070   00 00 00 44 72 43 4f 4d 05 b8 01 04 00 00 00 00  ...DrCOM........</div><div class="line">0080   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................</div><div class="line">0090   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................</div><div class="line">00a0   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................</div><div class="line">00b0   00 00 00 33 39 31 35 31 35 66 64 33 33 39 66 36  ...391515fd339f6</div><div class="line">00c0   32 62 35 33 30 63 64 36 33 61 30 32 37 63 64 34  2b530cd63a027cd4</div><div class="line">00d0   65 66 39 35 31 33 39 30 36 39 66 00 00 00 00 00  ef95139069f.....</div><div class="line">00e0   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................</div><div class="line">00f0   00 00 00 00                                      ....</div></pre></td></tr></table></figure></p>
<p>具体分析如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">07  //固定头</div><div class="line">01  //计数器，这里固定为01</div><div class="line">00 f4   //报文长度，这个长度是不定的，原因是用户名不定长</div><div class="line">03  //未知</div><div class="line">0b  //用户名长度</div><div class="line">28 d2 44 2d 90 69 //本机MAC</div><div class="line">c0 a8 c3 5f //本机IP</div><div class="line">02 22 00 24 //这个是固定值</div><div class="line">01 72 96 00 //这个来源于第一个回应包的第8到第11个字节</div><div class="line">4a 6a 72 32 //校验值，具体方法下面会讲到</div><div class="line">31 34 31 31 35 30 36 31 30 32 34 //用户名</div><div class="line">6c 7a 79 2d 70 63 //主机名</div><div class="line">df 05 05 05 //DNS-1</div><div class="line">df 06 06 06 //DNS-2</div><div class="line">...</div></pre></td></tr></table></figure></p>
<p>判断字段固不固定的主要方法还是多次登录，多账号登录，然后判断哪些部分是一致的，哪些部分每次都不同。该数据包有四个字节<code>4a 6a 72 32</code>每次捕获到的都不一样，也猜不出是什么含义，故使用反汇编工具IDA Pro进行逆向工程，文件为<strong>DrAuthSvr.dll</strong>。</p>
<p>首先找到一个开口：输入表里面的sendto函数。每次发送报文肯定都需要经过sendto函数，然后再通过交叉参考，最后找到发送数据的函数。我将其命名为<code>send_udp_packet(char *buf,int len)</code>。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> <span class="number">__</span><span class="function">cdecl <span class="title">send_udp_packet</span><span class="params">(<span class="keyword">char</span> *buf, <span class="keyword">int</span> len)</span></span></div><div class="line">&#123;</div><div class="line">    ...</div><div class="line">    <span class="keyword">if</span> ( sendto(dword_1057E9C4, buf, len, <span class="number">0</span>, &amp;to, <span class="number">16</span>) &lt; <span class="number">0</span> )</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>再次通过交叉参考，可以得知所有调用该函数的语句。其中有几个调用处写着:<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">send_udp_packet(buf, *(<span class="keyword">unsigned</span> <span class="number">__</span>int16 *)&amp;buf[<span class="number">2</span>])</div></pre></td></tr></table></figure></p>
<p>这与该数据包正好吻合（长度为buf[2]）。该数据包还有一个特征点即是buf[4]为3，最终可以确定发送这个包的函数。我们需要找的四个字节是[24:28]，函数比较靠前的位置有：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">*(<span class="number">_</span>DWORD *)&amp;buf[<span class="number">24</span>] = <span class="number">20000711</span>;</div><div class="line">*(<span class="number">_</span>DWORD *)&amp;buf[<span class="number">28</span>] = <span class="number">126</span>;</div></pre></td></tr></table></figure></p>
<p>也即是说函数直接对buf[24:32]的进行赋值。在比较靠后的位置还发现了：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">v4 = <span class="number">4</span> * ((*(<span class="keyword">unsigned</span> <span class="number">__</span>int16 *)&amp;buf[<span class="number">2</span>] + <span class="number">3</span>) / <span class="number">4</span>);</div><div class="line">*(<span class="number">_</span>WORD *)&amp;buf[<span class="number">2</span>] = v4;</div><div class="line">v5 = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v4 &gt;&gt; <span class="number">2</span>;</div><div class="line">v6 = <span class="number">0</span>;</div><div class="line"><span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; (<span class="keyword">signed</span> <span class="keyword">int</span>)v5; ++i )</div><div class="line">    v6 ^= *(<span class="number">_</span>DWORD *)&amp;buf[<span class="number">4</span> * i];</div><div class="line">*(<span class="number">_</span>DWORD *)&amp;buf[<span class="number">24</span>] = <span class="number">19680126</span> * v6;</div><div class="line">*(<span class="number">_</span>DWORD *)&amp;buf[<span class="number">28</span>] = <span class="number">0</span>;</div><div class="line">dword_1057F5BC = <span class="number">19680126</span> * v6;</div></pre></td></tr></table></figure></p>
<p>也就是说变量v5为长度的1/4，然后做下面的运算，最后把19680126*v6回填到buf[24:28]中，并将buf[28]置零。需要注意的是这里采用的都是小端法。最后还将计算的值保存起来，后面会用到。Go语言实现如下：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* 信息包校验码计算 */</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">putCode1</span><span class="params">(buf []<span class="keyword">byte</span>)</span></span> &#123;</div><div class="line">	v5 := <span class="built_in">len</span>(buf) &gt;&gt; <span class="number">2</span></div><div class="line">	<span class="keyword">var</span> v6 <span class="keyword">uint32</span></div><div class="line">	<span class="keyword">var</span> tmp <span class="keyword">uint32</span></div><div class="line">	<span class="keyword">var</span> b_tmp *bytes.Buffer</div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; v5; i++ &#123;</div><div class="line">		b_tmp = bytes.NewBuffer(buf[<span class="number">4</span>*i : <span class="number">4</span>*i+<span class="number">4</span>])</div><div class="line">		binary.Read(b_tmp, binary.LittleEndian, &amp;tmp)</div><div class="line">		v6 ^= tmp</div><div class="line">	&#125;</div><div class="line">	binary.LittleEndian.PutUint32(buf[<span class="number">24</span>:<span class="number">28</span>], v6*<span class="number">19680126</span>)</div><div class="line">	fmt.Println(v6 * <span class="number">19680126</span>)</div><div class="line">	binary.LittleEndian.PutUint32(globalCheck[:], v6*<span class="number">19680126</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>将这个二百余个字节的信息包发送出去后，服务器会发出第二个响应包。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">0000   07 01 30 00 04 0b 20 00 92 9a 9c 8c 01 00 00 00  ..0... .........</div><div class="line">0010   44 39 d8 ed 0c 45 fd 03 af 85 30 15 3c fa 04 68  D9...E....0.&lt;..h</div><div class="line">0020   b0 82 00 60 00 00 00 00 00 00 00 00 00 00 00 00  ...`............</div></pre></td></tr></table></figure></p>
<p>按照捕获到的数据包，客户端开始每隔一定时间发送两种不同的心跳包。</p>
<p>第一种心跳包有40个字节，正常情况下每次都会接连出现四个包。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">//Ping-1</div><div class="line">0000   07 02 28 00 0b 01 dc 02 6c 6f 00 00 00 00 00 00  ..(.....lo......</div><div class="line">0010   4d 71 96 00 00 00 00 00 00 00 00 00 00 00 00 00  Mq..............</div><div class="line">0020   00 00 00 00 00 00 00 00                          ........</div><div class="line"></div><div class="line">//Ping-2</div><div class="line">0000   07 02 28 00 0b 02 dc 02 6c 6f 00 00 00 00 00 00  ..(.....lo......</div><div class="line">0010   10 72 96 00 00 00 00 00 00 00 00 00 00 00 00 00  .r..............</div><div class="line">0020   00 00 00 00 00 00 00 00                          ........</div><div class="line"></div><div class="line">//Ping-3</div><div class="line">0000   07 03 28 00 0b 03 dc 02 6c 6f 00 00 00 00 00 00  ..(.....lo......</div><div class="line">0010   10 72 96 00 00 00 00 00 37 87 84 02 c0 a8 c3 5f  .r......7......_</div><div class="line">0020   00 00 00 00 00 00 00 00                          ........</div><div class="line"></div><div class="line">//Ping-4</div><div class="line">0000   07 03 28 00 0b 04 dc 02 6c 6f 00 00 00 00 00 00  ..(.....lo......</div><div class="line">0010   11 72 96 00 00 00 00 00 00 00 00 00 00 00 00 00  .r..............</div><div class="line">0020   00 00 00 00 00 00 00 00                          ........</div></pre></td></tr></table></figure>
<p>这四个数据包中，第1个和第3个为客户端发送，第2个和第4个则为服务器端响应。以最复杂的Ping-3作为例子进行分析：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">07  //头</div><div class="line">03  //计数器，一来一回为一次</div><div class="line">00 28   //包长度，即40个字节</div><div class="line">0b  //固定</div><div class="line">03  //步骤编号，该包为第三步</div><div class="line">dc 02 6c 6f //不清楚，不影响登陆</div><div class="line">10 72 96    //置零不影响</div><div class="line">37 87 84 02 //校验值，具体方法下面会讲到</div><div class="line">c0 a8 c3 5f //客户端IP</div></pre></td></tr></table></figure>
<p>跟上面分析方法相同，可以发现<code>37 87 84 02</code>基本没什么规律，应该也是一种校验值。继续使用IDA Pro进行静态分析，可以找到一个函数带有语句<code>buf[2]=40</code>，即是我们要找的发包函数。手动将buf类型改为char[40]后，可以找到这样一个代码片段：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> ( buf[<span class="number">5</span>] == <span class="number">3</span> )</div><div class="line">&#123;</div><div class="line">    v5 = <span class="number">0</span>;</div><div class="line">    v14 = <span class="number">0</span>;</div><div class="line">    v6 = <span class="number">0</span>;</div><div class="line">    <span class="keyword">do</span></div><div class="line">    &#123;</div><div class="line">        v7 = *(<span class="number">_</span>WORD *)&amp;buf[<span class="number">2</span> * v6++];</div><div class="line">        v5 ^= v7;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">while</span> ( v6 &lt; <span class="number">20</span> );</div><div class="line">    v8 = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)(dword_10077544 + <span class="number">1</span>) &lt; <span class="number">3</span>;</div><div class="line">    v9 = dword_10077544 == <span class="number">2</span>;</div><div class="line">    *(<span class="number">_</span>DWORD *)&amp;buf[<span class="number">24</span>] = <span class="number">711</span> * v5;</div></pre></td></tr></table></figure></p>
<p>Go语言实现如下：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* 40字节心跳包校验码计算 */</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">putCode2</span><span class="params">(buf []<span class="keyword">byte</span>)</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> tmp, v5 <span class="keyword">uint16</span></div><div class="line">	<span class="keyword">var</span> b_tmp *bytes.Buffer</div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">20</span>; i++ &#123;</div><div class="line">		b_tmp = bytes.NewBuffer(buf[<span class="number">2</span>*i : <span class="number">2</span>*i+<span class="number">2</span>])</div><div class="line">		binary.Read(b_tmp, binary.LittleEndian, &amp;tmp)</div><div class="line">		v5 ^= tmp</div><div class="line">	&#125;</div><div class="line">	binary.LittleEndian.PutUint32(buf[<span class="number">24</span>:<span class="number">28</span>], <span class="keyword">uint32</span>(v5)*<span class="number">711</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>第二种心跳包是38个字节，在第一种心跳包发出后大约10秒发出。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">0000   ff 4a 6a 72 32 45 c7 d8 6d 18 38 24 c0 20 91 2b  .Jjr2E..m.8$. .+</div><div class="line">0010   6c 00 00 00 44 72 63 6f c0 a8 7f 81 af 0b c0 a8  l...Drco........</div><div class="line">0020   c3 5f 01 34 33 9b                                ._.43.</div></pre></td></tr></table></figure></p>
<p>对这个数据包做分析：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">ff  //固定头</div><div class="line">4a 6a 72 32 //发送信息包时的校验值</div><div class="line">45 c7 d8 6d 18 38 24 c0 20 91 2b 6c //Challenged-Password的后12位</div><div class="line">44 72 63 6f //字符串Drco</div><div class="line">c0 a8 7f 81 //服务器IP</div><div class="line">af 0b   //下面会讲到</div><div class="line">c0 a8 c3 5f //客户端IP</div><div class="line">01 34   //下面会讲到</div><div class="line">3e 9b   //取当前时间的最后两个字节</div></pre></td></tr></table></figure></p>
<p>第1个字节开始往后16个字节，通过与早前的数据包做比对即可推出；而最后的36、37个字节，则是通过IDA Pro得知：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">v0 = <span class="number">_</span>time64(<span class="number">0</span>);</div><div class="line">...</div><div class="line">*(<span class="number">_</span>WORD *)&amp;buf[<span class="number">36</span>] = v0;</div></pre></td></tr></table></figure></p>
<p>而服务器IP和客户端IP后面分别带的两个字节，却始终未能使用逆向工程分析出来，Github上的代码也只是与反汇编出来的代码一致，跟我拿到的数据并不相符，最后只能通过慢慢比对，寻找线索。<br>首先可以发现的是，第34个字节固定为01，然后比对其他历史数据包，最终在服务器第二次响应的数据包中，找到了每次登陆都不同的三个字节：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">0000   07 01 30 00 04 0b 20 00 92 9a 9c 8c 01 00 00 00  ..0... .........</div><div class="line">0010   44 39 d8 ed 0c 45 fd 03 af 85 30 15 3c fa 04 68  D9...E....0.&lt;..h</div><div class="line">0020   b0 82 00 60 00 00 00 00 00 00 00 00 00 00 00 00  ...`............</div></pre></td></tr></table></figure></p>
<p>其中第24、25个字节<code>af 85</code>，第31个字节<code>68</code>每次登陆都会有所变化，而第24个字节总是与上述心跳包第28个字节相同，第25个字节和心跳包第29个字节则存在以下关系：<br>$$<br>H_{29}=\left\{<br>\begin{array}{rcl}<br>R_{25}{\scriptstyle&lt;&lt;}1&amp;&amp;{R_{25}&lt;128}\\<br>(R_{25}{\scriptstyle&lt;&lt;}1)|1&amp;&amp;{R_{25}\geq128}<br>\end{array} \right.<br>$$</p>
<p>同理可以得知第30个字节总是与心跳包第35个字节存在以下关系：</p>
<p>$$<br>H_{35}=\left\{<br>\begin{array}{rcl}<br>R_{30} {\scriptstyle &gt;&gt;}1&amp;&amp;{R_{30}为偶数}\\<br>(R_{30} {\scriptstyle &gt;&gt;}1)|128&amp;&amp;{R_{30}为奇数}<br>\end{array} \right.<br>$$</p>
<h2 id="0x05-心跳包部分的Go语言实现"><a href="#0x05-心跳包部分的Go语言实现" class="headerlink" title="0x05 心跳包部分的Go语言实现"></a>0x05 心跳包部分的Go语言实现</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">udpServerAddr, err = net.ResolveUDPAddr(<span class="string">"udp4"</span>, <span class="string">"192.168.127.129:61440"</span>)</div><div class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">	fmt.Println(err)</div><div class="line">	os.Exit(<span class="number">0</span>)</div><div class="line">&#125;</div><div class="line">udpConn, err = net.DialUDP(<span class="string">"udp4"</span>, <span class="literal">nil</span>, udpServerAddr)</div><div class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">	fmt.Println(err)</div><div class="line">	os.Exit(<span class="number">0</span>)</div><div class="line">&#125;</div><div class="line"><span class="keyword">defer</span> udpConn.Close()</div><div class="line"><span class="keyword">go</span> recvPing()</div></pre></td></tr></table></figure>
<p>用内置的net.DialUDP建立一个UDP对话到 192.168.127.129:61440，这里注意客户端的端口并<strong>不要求</strong>一定是61440，前面提到的那个关于UDP61440的错误，就是因为偶尔启动时61440端口由于各种原因被占用，其实只需要让系统自动分配一个端口即可。</p>
<p>然后启动一个协程，负责UDP回应的接受，对各种形式的回应做出处理。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* 接收服务器的UDP回应 */</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">recvPing</span><span class="params">()</span></span> &#123;</div><div class="line">	data := [<span class="number">4096</span>]<span class="keyword">byte</span>&#123;&#125;</div><div class="line">	<span class="keyword">for</span> &#123;</div><div class="line">		n, _, err := udpConn.ReadFromUDP(data[<span class="number">0</span>:])</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			fmt.Println(err)</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> n &gt; <span class="number">0</span> &#123;</div><div class="line">			<span class="keyword">if</span> data[<span class="number">0</span>] == <span class="number">0x07</span> &#123; <span class="comment">//应答包</span></div><div class="line">				<span class="keyword">if</span> data[<span class="number">2</span>] == <span class="number">0x10</span> &amp;&amp; n == <span class="number">32</span> &#123; <span class="comment">//第一次应答</span></div><div class="line">					sendPingInfo(data[<span class="number">8</span>:<span class="number">12</span>]) <span class="comment">//发送用户信息包</span></div><div class="line">				&#125; <span class="keyword">else</span> <span class="keyword">if</span> data[<span class="number">2</span>] == <span class="number">0x30</span> &#123; <span class="comment">//第二次应答</span></div><div class="line">					UknCode_1 = data[<span class="number">24</span>]</div><div class="line">					UknCode_2 = data[<span class="number">25</span>]</div><div class="line">					UknCode_3 = data[<span class="number">30</span>]</div><div class="line">					UknCode_3 = data[<span class="number">31</span>]</div><div class="line">					<span class="keyword">go</span> pingCycle() <span class="comment">//发送Ping-1</span></div><div class="line">				&#125; <span class="keyword">else</span> <span class="keyword">if</span> data[<span class="number">2</span>] == <span class="number">0x28</span> &#123; <span class="comment">//Ping应答</span></div><div class="line">					<span class="keyword">if</span> data[<span class="number">5</span>] == <span class="number">0x02</span> &#123; <span class="comment">//收到Ping-2</span></div><div class="line">						sendPing40(<span class="number">3</span>) <span class="comment">//发送Ping-3</span></div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>还有一个协程则负责两种心跳包的交替发送。这里注意发送心跳包是定时发送的，因为并不是每个心跳包都会收到回应，不能依赖于收到回应后再继续发送。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* 两种心跳包循环发送 */</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">pingCycle</span><span class="params">()</span></span> &#123;</div><div class="line">	time.Sleep(<span class="number">1</span> * time.Second)</div><div class="line">	<span class="keyword">for</span> &#123;</div><div class="line">		sendPing40(<span class="number">1</span>)</div><div class="line">		time.Sleep(<span class="number">10</span> * time.Second)</div><div class="line">		sendPing38()</div><div class="line">		time.Sleep(<span class="number">5</span> * time.Second)</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>其他包的发送函数就只是简单的对数据进行封装，这里就不再一一给出。</p>
<h2 id="0x06-总结"><a href="#0x06-总结" class="headerlink" title="0x06 总结"></a>0x06 总结</h2>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  


          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="CuberL" />
          <p class="site-author-name" itemprop="name">CuberL</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">1</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          

          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">CuberL</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->



  



  




  
  

  

  

  

</body>
</html>
